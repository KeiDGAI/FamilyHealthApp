{% extends "base.html" %}

{% block title %}ç›®æ¨™é”æˆçŠ¶æ³ - å®¶æ—å¥åº·ç®¡ç†{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row">
        <div class="col-12">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="text-white mb-1">ğŸ† ç›®æ¨™é”æˆçŠ¶æ³</h1>
                    <p class="text-muted">éå»7æ—¥é–“ã®ç›®æ¨™é”æˆå®Ÿç¸¾ã¨è©³ç´°åˆ†æ</p>
                </div>
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>æˆ»ã‚‹
                </a>
            </div>

            <!-- é€±é–“ã‚µãƒãƒªãƒ¼ -->
            <div class="row mb-4">
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card bg-success bg-gradient">
                        <div class="card-body text-center">
                            <i class="fas fa-trophy fa-2x mb-2"></i>
                            <h3 class="card-title">{{ weekly_achievements|selectattr('step_goal_achieved')|list|length }}/7</h3>
                            <p class="card-text">æ­©æ•°ç›®æ¨™é”æˆæ—¥æ•°</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card bg-warning bg-gradient">
                        <div class="card-body text-center text-dark">
                            <i class="fas fa-fire fa-2x mb-2"></i>
                            <h3 class="card-title">{{ weekly_achievements|selectattr('calorie_goal_achieved')|list|length }}/7</h3>
                            <p class="card-text">ã‚«ãƒ­ãƒªãƒ¼ç›®æ¨™é”æˆæ—¥æ•°</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card bg-info bg-gradient">
                        <div class="card-body text-center">
                            <i class="fas fa-star fa-2x mb-2"></i>
                            <h3 class="card-title">{{ weekly_achievements|map(attribute='total_achievements')|sum }}</h3>
                            <p class="card-text">ç·å®Ÿç¸¾ãƒã‚¤ãƒ³ãƒˆ</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card bg-primary bg-gradient">
                        <div class="card-body text-center">
                            <i class="fas fa-percentage fa-2x mb-2"></i>
                            <h3 class="card-title">{{ ((weekly_achievements|map(attribute='total_achievements')|sum / 14) * 100)|round }}%</h3>
                            <p class="card-text">é€±é–“é”æˆç‡</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é”æˆçŠ¶æ³ãƒãƒ£ãƒ¼ãƒˆ -->
            <div class="row mb-4">
                <div class="col-lg-8 mb-4">
                    <div class="card bg-dark">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-bar me-2"></i>é€±é–“é”æˆçŠ¶æ³ã‚°ãƒ©ãƒ•
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas id="achievementChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 mb-4">
                    <div class="card bg-dark">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-medal me-2"></i>å®Ÿç¸¾ãƒãƒƒã‚¸
                            </h5>
                        </div>
                        <div class="card-body">
                            {% set step_achievements = weekly_achievements|selectattr('step_goal_achieved')|list|length %}
                            {% set calorie_achievements = weekly_achievements|selectattr('calorie_goal_achieved')|list|length %}
                            
                            <!-- ã‚¹ãƒ†ãƒƒãƒ—ãƒãƒƒã‚¸ -->
                            <div class="mb-3">
                                {% if step_achievements == 7 %}
                                <div class="badge bg-success fs-6 mb-2 w-100">
                                    ğŸ¥‡ ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆãƒ»ã‚¦ã‚©ãƒ¼ã‚«ãƒ¼
                                </div>
                                {% elif step_achievements >= 5 %}
                                <div class="badge bg-primary fs-6 mb-2 w-100">
                                    ğŸ¥ˆ ã‚¹ãƒ†ãƒƒãƒ—ãƒ»ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³
                                </div>
                                {% elif step_achievements >= 3 %}
                                <div class="badge bg-warning fs-6 mb-2 w-100">
                                    ğŸ¥‰ ã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°ãƒ»ã‚¨ãƒ³ã‚¹ãƒ¼ã‚¸ã‚¢ã‚¹ãƒˆ
                                </div>
                                {% endif %}
                            </div>

                            <!-- ã‚«ãƒ­ãƒªãƒ¼ãƒãƒƒã‚¸ -->
                            <div class="mb-3">
                                {% if calorie_achievements == 7 %}
                                <div class="badge bg-danger fs-6 mb-2 w-100">
                                    ğŸ”¥ ã‚«ãƒ­ãƒªãƒ¼ãƒ»ãƒã‚¹ã‚¿ãƒ¼
                                </div>
                                {% elif calorie_achievements >= 5 %}
                                <div class="badge bg-warning fs-6 mb-2 w-100">
                                    âš¡ ã‚¨ãƒŠã‚¸ãƒ¼ãƒ»ãƒãƒ¼ãƒŠãƒ¼
                                </div>
                                {% elif calorie_achievements >= 3 %}
                                <div class="badge bg-info fs-6 mb-2 w-100">
                                    ğŸ’ª ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ»ãƒ©ã‚¤ãƒ•
                                </div>
                                {% endif %}
                            </div>

                            <!-- ã‚³ãƒ³ã‚·ã‚¹ãƒ†ãƒ³ã‚·ãƒ¼ãƒãƒƒã‚¸ -->
                            {% set consecutive_days = 0 %}
                            {% set max_consecutive = 0 %}
                            {% for achievement in weekly_achievements %}
                                {% if achievement.total_achievements >= 1 %}
                                    {% set consecutive_days = consecutive_days + 1 %}
                                    {% if consecutive_days > max_consecutive %}
                                        {% set max_consecutive = consecutive_days %}
                                    {% endif %}
                                {% else %}
                                    {% set consecutive_days = 0 %}
                                {% endif %}
                            {% endfor %}

                            {% if max_consecutive >= 7 %}
                            <div class="badge bg-purple fs-6 mb-2 w-100" style="background-color: #6f42c1 !important;">
                                ğŸ¯ ã‚³ãƒ³ã‚·ã‚¹ãƒ†ãƒ³ã‚·ãƒ¼ãƒ»ã‚­ãƒ³ã‚°
                            </div>
                            {% elif max_consecutive >= 5 %}
                            <div class="badge bg-secondary fs-6 mb-2 w-100">
                                ğŸ”„ ç¿’æ…£ãƒ¡ãƒ¼ã‚«ãƒ¼
                            </div>
                            {% endif %}

                            <div class="text-center mt-3">
                                <small class="text-muted">æ¬¡ã®ãƒãƒƒã‚¸ã¾ã§é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è©³ç´°é”æˆçŠ¶æ³ãƒ†ãƒ¼ãƒ–ãƒ« -->
            <div class="card bg-dark mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar me-2"></i>æ—¥åˆ¥é”æˆçŠ¶æ³è©³ç´°
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-dark table-striped">
                            <thead>
                                <tr>
                                    <th>æ—¥ä»˜</th>
                                    <th>æ­©æ•°</th>
                                    <th>ç›®æ¨™é”æˆ</th>
                                    <th>ã‚«ãƒ­ãƒªãƒ¼</th>
                                    <th>ç›®æ¨™é”æˆ</th>
                                    <th>é”æˆåº¦</th>
                                    <th>è©•ä¾¡</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for achievement in weekly_achievements %}
                                <tr>
                                    <td>{{ achievement.date }}</td>
                                    <td>
                                        <span class="badge {% if achievement.step_goal_achieved %}bg-success{% else %}bg-secondary{% endif %}">
                                            {{ achievement.steps|default(0) }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if achievement.step_goal_achieved %}
                                            <i class="fas fa-check-circle text-success"></i>
                                        {% else %}
                                            <i class="fas fa-times-circle text-danger"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge {% if achievement.calorie_goal_achieved %}bg-success{% else %}bg-secondary{% endif %}">
                                            {{ achievement.calories|default(0) }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if achievement.calorie_goal_achieved %}
                                            <i class="fas fa-check-circle text-success"></i>
                                        {% else %}
                                            <i class="fas fa-times-circle text-danger"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar {% if achievement.total_achievements == 2 %}bg-success{% elif achievement.total_achievements == 1 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                 role="progressbar" 
                                                 style="width: {{ (achievement.total_achievements / 2 * 100)|round }}%"
                                                 aria-valuenow="{{ achievement.total_achievements }}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="2">
                                                {{ achievement.total_achievements }}/2
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if achievement.total_achievements == 2 %}
                                            <span class="badge bg-success">å®Œç’§</span>
                                        {% elif achievement.total_achievements == 1 %}
                                            <span class="badge bg-warning">è‰¯å¥½</span>
                                        {% else %}
                                            <span class="badge bg-danger">è¦æ”¹å–„</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="card bg-dark">
                        <div class="card-header bg-success">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-thumbs-up me-2"></i>ä»Šé€±ã®æˆæœ
                            </h5>
                        </div>
                        <div class="card-body">
                            {% set total_achievements = weekly_achievements|map(attribute='total_achievements')|sum %}
                            {% if total_achievements >= 12 %}
                            <div class="alert alert-success">
                                <h6 class="alert-heading">ç´ æ™´ã‚‰ã—ã„æˆæœã§ã™ï¼</h6>
                                <p>ã“ã®èª¿å­ã§å¥åº·ç¿’æ…£ã‚’ç¶™ç¶šã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚ã‚ãªãŸã®åŠªåŠ›ãŒç¢ºå®Ÿã«å®Ÿã‚’çµã‚“ã§ã„ã¾ã™ã€‚</p>
                            </div>
                            {% elif total_achievements >= 8 %}
                            <div class="alert alert-info">
                                <h6 class="alert-heading">é †èª¿ãªé€²æ­©ã§ã™ï¼</h6>
                                <p>è‰¯ã„ãƒšãƒ¼ã‚¹ã§ç›®æ¨™ã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚å°‘ã—ãšã¤ã§ã‚‚ç¶™ç¶šã™ã‚‹ã“ã¨ãŒå¤§åˆ‡ã§ã™ã€‚</p>
                            </div>
                            {% elif total_achievements >= 4 %}
                            <div class="alert alert-warning">
                                <h6 class="alert-heading">ã‚‚ã†å°‘ã—ã§ã™ï¼</h6>
                                <p>ç›®æ¨™é”æˆã¾ã§ã‚ã¨ä¸€æ­©ã§ã™ã€‚å°ã•ãªåŠªåŠ›ã®ç©ã¿é‡ã­ãŒå¤§ããªæˆæœã«ã¤ãªãŒã‚Šã¾ã™ã€‚</p>
                            </div>
                            {% else %}
                            <div class="alert alert-danger">
                                <h6 class="alert-heading">æ–°ã—ã„ã‚¹ã‚¿ãƒ¼ãƒˆã‚’ï¼</h6>
                                <p>ä»Šé€±ã¯æ€ã†ã‚ˆã†ã«ã„ã‹ãªã‹ã£ãŸã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€æ˜æ—¥ã‹ã‚‰æ–°ãŸã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†ã€‚</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="col-lg-6 mb-4">
                    <div class="card bg-dark">
                        <div class="card-header bg-primary">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-target me-2"></i>æ”¹å–„ææ¡ˆ
                            </h5>
                        </div>
                        <div class="card-body">
                            <h6>æ¥é€±ã«å‘ã‘ã¦ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹:</h6>
                            <ul class="list-unstyled">
                                {% if weekly_achievements|selectattr('step_goal_achieved')|list|length < 4 %}
                                <li><i class="fas fa-walking text-primary me-2"></i>æ•£æ­©ã®ç¿’æ…£ã‚’å¢—ã‚„ã—ã¦ã¿ã¾ã—ã‚‡ã†</li>
                                {% endif %}
                                {% if weekly_achievements|selectattr('calorie_goal_achieved')|list|length < 4 %}
                                <li><i class="fas fa-dumbbell text-warning me-2"></i>è»½ã„é‹å‹•ã‚’å–ã‚Šå…¥ã‚Œã¦ã¿ã¾ã—ã‚‡ã†</li>
                                {% endif %}
                                <li><i class="fas fa-users text-success me-2"></i>å®¶æ—ã¨ä¸€ç·’ã«æ´»å‹•ã—ã¦ã¿ã¾ã—ã‚‡ã†</li>
                                <li><i class="fas fa-calendar text-info me-2"></i>æ¯æ—¥åŒã˜æ™‚é–“ã«æ´»å‹•ã™ã‚‹ç¿’æ…£ã‚’</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
            <div class="text-center mb-4">
                <a href="{{ url_for('goals') }}" class="btn btn-primary me-2">
                    <i class="fas fa-edit me-2"></i>ç›®æ¨™ã‚’èª¿æ•´
                </a>
                <a href="{{ url_for('family_challenges') }}" class="btn btn-success me-2">
                    <i class="fas fa-users me-2"></i>å®¶æ—ãƒãƒ£ãƒ¬ãƒ³ã‚¸
                </a>
                <button class="btn btn-info" onclick="shareAchievements()">
                    <i class="fas fa-share me-2"></i>æˆæœã‚’ã‚·ã‚§ã‚¢
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // é”æˆçŠ¶æ³ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
    const weeklyData = {{ weekly_achievements|tojson }};
    const dates = weeklyData.map(d => d.date);
    const stepAchievements = weeklyData.map(d => d.step_goal_achieved ? 1 : 0);
    const calorieAchievements = weeklyData.map(d => d.calorie_goal_achieved ? 1 : 0);

    // é”æˆçŠ¶æ³ãƒãƒ£ãƒ¼ãƒˆ
    new Chart(document.getElementById('achievementChart'), {
        type: 'bar',
        data: {
            labels: dates,
            datasets: [
                {
                    label: 'æ­©æ•°ç›®æ¨™é”æˆ',
                    data: stepAchievements,
                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                },
                {
                    label: 'ã‚«ãƒ­ãƒªãƒ¼ç›®æ¨™é”æˆ',
                    data: calorieAchievements,
                    backgroundColor: 'rgba(255, 99, 132, 0.8)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: {
                        color: '#fff'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 1,
                    ticks: {
                        stepSize: 1,
                        color: '#fff',
                        callback: function(value) {
                            return value === 1 ? 'é”æˆ' : 'æœªé”æˆ';
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: '#fff'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    });
});

function shareAchievements() {
    const totalAchievements = {{ weekly_achievements|map(attribute='total_achievements')|sum }};
    const stepDays = {{ weekly_achievements|selectattr('step_goal_achieved')|list|length }};
    const calorieDays = {{ weekly_achievements|selectattr('calorie_goal_achieved')|list|length }};
    
    const message = `ä»Šé€±ã®å¥åº·ç›®æ¨™é”æˆçŠ¶æ³:\nğŸš¶æ­©æ•°ç›®æ¨™: ${stepDays}/7æ—¥é”æˆ\nğŸ”¥ã‚«ãƒ­ãƒªãƒ¼ç›®æ¨™: ${calorieDays}/7æ—¥é”æˆ\nâ­ç·åˆã‚¹ã‚³ã‚¢: ${totalAchievements}/14ãƒã‚¤ãƒ³ãƒˆ\n\nå®¶æ—å¥åº·ç®¡ç†ã‚¢ãƒ—ãƒªã§å¥åº·ç®¡ç†ä¸­ï¼`;
    
    if (navigator.share) {
        navigator.share({
            title: 'ä»Šé€±ã®å¥åº·å®Ÿç¸¾',
            text: message
        });
    } else {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        navigator.clipboard.writeText(message).then(() => {
            alert('æˆæœãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼');
        });
    }
}
</script>
{% endblock %}